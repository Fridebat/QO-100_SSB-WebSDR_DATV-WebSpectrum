// =================================================================================
// Anti Aliasing Mixer after down mixer
// =================================================================================

#include <stdio.h>
#include <stdlib.h>
#include "antialiasing.h"
#include "websocketserver.h"

/*
 * three different anti aliasing filters
 * 
 * Len = 199
 * CPU load: 15-17% / 11%
 * Artifacts: 1st clearly audible, 2nd audible but very quiet
 * 
 * Len = 299
 * CPU load: 15-17% / 10%
 * Artifacts: 1st audible
 * 
 * Len = 512
 * CPU load: 17-19% / 14%
 * Artifacts: 1st audible
 * 
 * the 299 filter look to be the best compromise
 * 
 */

extern double dm_coef_299[299];

#define DM_COEFLEN 299
double *dm_coef = dm_coef_299;

double i_circbuf[MAX_CLIENTS][DM_COEFLEN];
double q_circbuf[MAX_CLIENTS][DM_COEFLEN];
int i_wridx[MAX_CLIENTS];
int q_wridx[MAX_CLIENTS];

void fir_filter_i_ssb_inc(double sample, int client)
{
    i_circbuf[client][i_wridx[client]++] = sample;
    i_wridx[client] %= DM_COEFLEN;
}

/*
 * this FIR filter is optimized for symmetric FIR coeffs with odd length, i.e.: 299
 * it calculates lower and upper part simultaneous and reduces the multiplications by 50%
 */
int fir_filter_i_ssb(double sample, int client)
{
double *pcoeff = dm_coef;
int *pidx = &(i_wridx[client]);
double *buf = i_circbuf[client];

    // write value to buffer
    buf[(*pidx)++] = sample;
    (*pidx) %= DM_COEFLEN;
    
    // calculate new value
    double y = 0;
    int idxl = *pidx;
    int idxh = (*pidx)-1;
    for(int i = 0; i < (DM_COEFLEN/2); i++)
    {
        idxl %= DM_COEFLEN;
        idxh %= DM_COEFLEN;
        
        y += (*pcoeff++ * (buf[idxl++] + buf[idxh--]));
    }
    // and the middle value
    y += (*pcoeff * buf[idxl]);
    
    return (int)y;
}

void fir_filter_q_ssb_inc(double sample, int client)
{
    q_circbuf[client][q_wridx[client]++] = sample;
    q_wridx[client] %= DM_COEFLEN;
}

int fir_filter_q_ssb(double sample, int client)
{
double *pcoeff = dm_coef;
double y;

    // write value to buffer
    q_circbuf[client][q_wridx[client]] = sample;
    
    // increment write index
    q_wridx[client]++;
    q_wridx[client] %= DM_COEFLEN;
    
    // calculate new value
    y = 0;
    int idxl = q_wridx[client];
    int idxh = q_wridx[client]-1;
    for(int i = 0; i < (DM_COEFLEN/2); i++)
    {
        idxl %= DM_COEFLEN;
        idxh %= DM_COEFLEN;
        
        y += (*pcoeff++ * (q_circbuf[client][idxl++] + q_circbuf[client][idxh--]));
    }
    
    // and the middle value
    y += (*pcoeff * q_circbuf[client][idxl]);

    return (int)y;
}

double dm_coef_299[299] = 
{
0.000138109810246656	,
0.000138060486785108	,
0.000137255209408339	,
0.000135635388991111	,
0.000133142345782287	,
0.000129717587746523	,
0.000125303102531769	,
0.000119841662322463	,
0.000113277140751526	,
0.000105554840958695	,
0.0000966218337984943	,
0.0000864273051190333	,
0.0000749229109529329	,
0.000062063139384743	,
0.000047805677785466	,
0.0000321117840347877	,
0.0000149466602857168	,
-0.00000372017223502084	,
-0.0000239144989538969	,
-0.0000456570398189351	,
-0.0000689630809689919	,
-0.0000938421119027276	,
-0.000120297469878908	,
-0.000148325993305815	,
-0.000177917685896674	,
-0.000209055393379863	,
-0.000241714494556966	,
-0.000275862608498373	,
-0.000311459319654778	,
-0.00034845592264362	,
-0.00038679518844196	,
-0.00042641115368158	,
-0.000467228934698035	,
-0.000509164567933137	,
-0.000552124878229799	,
-0.000596007376489477	,
-0.000640700188085712	,
-0.000686082013342616	,
-0.000732022121294812	,
-0.000778380377845488	,
-0.000825007309332169	,
-0.000871744202395893	,
-0.000918423240928909	,
-0.000964867680749343	,
-0.00101089206251877	,
-0.00105630246328087	,
-0.00110089678685657	,
-0.0011444650931843	,
-0.00118678996654298	,
-0.00122764692244141	,
-0.00126680485280121	,
-0.0013040265089015	,
-0.00133906902139373	,
-0.00137168445653396	,
-0.00140162040761924	,
-0.00142862062045422	,
-0.00145242565151528	,
-0.00147277355732227	,
-0.00148940061337378	,
-0.00150204206085059	,
-0.00151043287914541	,
-0.00151430858213437	,
-0.00151340603596954	,
-0.00150746429604046	,
-0.00149622546062943	,
-0.00147943553866826	,
-0.00145684532889587	,
-0.00142821130761621	,
-0.00139329652216494	,
-0.00135187148711238	,
-0.00130371508015883	,
-0.0012486154346183	,
-0.00118637082533707	,
-0.00111679054485542	,
-0.0010396957665947	,
-0.000954920391837559	,
-0.000862311877267228	,
-0.000761732039842001	,
-0.000653057835804316	,
-0.000536182110659413	,
-0.000411014317007094	,
-0.000277481197171228	,
-0.000135527427645512	,
0.0000148837775396521	,
0.000173770107325583	,
0.000341129640694647	,
0.000516940382863359	,
0.000701159853027953	,
0.0008937247259458	,
0.00109455052948002	,
0.00130353140006844	,
0.00152053989790218	,
0.0017454268834142	,
0.00197802145648471	,
0.0022181309595691	,
0.00246554104574596	,
0.0027200158124678	,
0.00298129800157717	,
0.00324910926592585	,
0.0035231505027058	,
0.0038031022533687	,
0.00408862516977687	,
0.00437936054599274	,
0.00467493091487849	,
0.00497494070844191	,
0.00527897698063118	,
0.00558661019104941	,
0.00589739504783209	,
0.00621087140770658	,
0.00652656523103405	,
0.00684398958942194	,
0.00716264572328881	,
0.00748202414656605	,
0.00780160579553122	,
0.00812086321858804	,
0.00843926180363837	,
0.0087562610395325	,
0.00907131580793724	,
0.00938387770182589	,
0.00969339636667249	,
0.00999932086032395	,
0.0103011010274287	,
0.0105981888842209	,
0.010890040009392	,
0.011176114936734	,
0.0114558805451997	,
0.0117288114420093	,
0.011994391334427	,
0.0122521143858447	,
0.0125014865518355	,
0.0127420268918884	,
0.012973268852589	,
0.0131947615180923	,
0.0134060708238196	,
0.0136067807294209	,
0.0137964943471623	,
0.013974835022033	,
0.0141414473600172	,
0.0142959982011349	,
0.0144381775340341	,
0.0145676993490996	,
0.0146843024272463	,
0.0147877510617708	,
0.0148778357108545	,
0.0149543735785417	,
0.0150172091222496	,
0.0150662144851118	,
0.0151012898517088	,
0.0151223637259925	,
0.0151293931304717	,
0.0151223637259925	,
0.0151012898517088	,
0.0150662144851118	,
0.0150172091222496	,
0.0149543735785417	,
0.0148778357108545	,
0.0147877510617708	,
0.0146843024272463	,
0.0145676993490996	,
0.0144381775340341	,
0.0142959982011349	,
0.0141414473600172	,
0.013974835022033	,
0.0137964943471623	,
0.0136067807294209	,
0.0134060708238196	,
0.0131947615180923	,
0.012973268852589	,
0.0127420268918884	,
0.0125014865518355	,
0.0122521143858447	,
0.011994391334427	,
0.0117288114420093	,
0.0114558805451997	,
0.011176114936734	,
0.010890040009392	,
0.0105981888842209	,
0.0103011010274287	,
0.00999932086032395	,
0.00969339636667249	,
0.00938387770182589	,
0.00907131580793724	,
0.0087562610395325	,
0.00843926180363837	,
0.00812086321858804	,
0.00780160579553122	,
0.00748202414656605	,
0.00716264572328881	,
0.00684398958942194	,
0.00652656523103405	,
0.00621087140770658	,
0.00589739504783209	,
0.00558661019104941	,
0.00527897698063118	,
0.00497494070844191	,
0.00467493091487849	,
0.00437936054599274	,
0.00408862516977687	,
0.0038031022533687	,
0.0035231505027058	,
0.00324910926592585	,
0.00298129800157717	,
0.0027200158124678	,
0.00246554104574596	,
0.0022181309595691	,
0.00197802145648471	,
0.0017454268834142	,
0.00152053989790218	,
0.00130353140006844	,
0.00109455052948002	,
0.0008937247259458	,
0.000701159853027953	,
0.000516940382863359	,
0.000341129640694647	,
0.000173770107325583	,
0.0000148837775396521	,
-0.000135527427645512	,
-0.000277481197171228	,
-0.000411014317007094	,
-0.000536182110659413	,
-0.000653057835804316	,
-0.000761732039842001	,
-0.000862311877267228	,
-0.000954920391837559	,
-0.0010396957665947	,
-0.00111679054485542	,
-0.00118637082533707	,
-0.0012486154346183	,
-0.00130371508015883	,
-0.00135187148711238	,
-0.00139329652216494	,
-0.00142821130761621	,
-0.00145684532889587	,
-0.00147943553866826	,
-0.00149622546062943	,
-0.00150746429604046	,
-0.00151340603596954	,
-0.00151430858213437	,
-0.00151043287914541	,
-0.00150204206085059	,
-0.00148940061337378	,
-0.00147277355732227	,
-0.00145242565151528	,
-0.00142862062045422	,
-0.00140162040761924	,
-0.00137168445653396	,
-0.00133906902139373	,
-0.0013040265089015	,
-0.00126680485280121	,
-0.00122764692244141	,
-0.00118678996654298	,
-0.0011444650931843	,
-0.00110089678685657	,
-0.00105630246328087	,
-0.00101089206251877	,
-0.000964867680749343	,
-0.000918423240928909	,
-0.000871744202395893	,
-0.000825007309332169	,
-0.000778380377845488	,
-0.000732022121294812	,
-0.000686082013342616	,
-0.000640700188085712	,
-0.000596007376489477	,
-0.000552124878229799	,
-0.000509164567933137	,
-0.000467228934698035	,
-0.00042641115368158	,
-0.00038679518844196	,
-0.00034845592264362	,
-0.000311459319654778	,
-0.000275862608498373	,
-0.000241714494556966	,
-0.000209055393379863	,
-0.000177917685896674	,
-0.000148325993305815	,
-0.000120297469878908	,
-0.0000938421119027276	,
-0.0000689630809689919	,
-0.0000456570398189351	,
-0.0000239144989538969	,
-0.00000372017223502084	,
0.0000149466602857168	,
0.0000321117840347877	,
0.000047805677785466	,
0.000062063139384743	,
0.0000749229109529329	,
0.0000864273051190333	,
0.0000966218337984943	,
0.000105554840958695	,
0.000113277140751526	,
0.000119841662322463	,
0.000125303102531769	,
0.000129717587746523	,
0.000133142345782287	,
0.000135635388991111	,
0.000137255209408339	,
0.000138060486785108	,
0.000138109810246656	
};
